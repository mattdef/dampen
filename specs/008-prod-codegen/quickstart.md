# Quickstart: Production Mode with Static Code Generation

**Feature**: 008-prod-codegen | **Date**: 2026-01-08

## Overview

Production mode generates static Rust code at compile time, eliminating runtime XML parsing for optimal performance.

## Prerequisites

- Rust 1.75+ (MSRV)
- Gravity CLI tools installed
- Existing Gravity project using development mode

## Quick Start

### 1. Create a New Production Project

```bash
gravity new myapp
cd myapp
```

New projects are automatically configured with production mode.

### 2. Migrate Existing Project

For projects created before production mode support:

```bash
# The gravity new command already created build.rs
# Verify it exists:
ls -la build.rs

# If missing, create from template:
cp crates/gravity-cli/templates/build.rs build.rs

# Update Cargo.toml to reference build.rs:
# [package]
# build = "build.rs"
```

### 3. Define Handlers

Handlers are functions marked with `#[ui_handler]`:

```rust
use gravity_macros::ui_handler;

#[ui_handler]
fn on_click(model: &mut Model) {
    model.count += 1;
}

#[ui_handler]
fn on_submit(model: &mut Model, value: String) {
    model.input = value;
    model.submitted = true;
}
```

### 4. Build for Production

```bash
# Debug build
gravity build --prod

# Release build (recommended for production)
gravity build --prod --release
```

### 5. Run the Generated Binary

```bash
./target/release/myapp
```

## File Structure

```
myproject/
├── Cargo.toml           # [package] + build = "build.rs"
├── build.rs             # Generated by gravity new
├── src/
│   ├── main.rs          # App entry point
│   └── ui/
│       └── window.gravity
└── target/
    └── release/
        └── myapp        # Production binary
```

## Development vs Production Mode

| Aspect | Development Mode | Production Mode |
|--------|-----------------|-----------------|
| UI Loading | Runtime XML parsing | Static code generation |
| Build Speed | Fast (no code gen) | Slower (code generation) |
| Startup Time | Slower (parsing) | Faster (no parsing) |
| Debugging | Easy (XML readable) | Generated code readable |
| Iteration | `cargo run` | Full rebuild |

### Switching Between Modes

**Development Mode** (default):
```bash
cargo run
```

**Production Mode**:
```bash
gravity build --prod --release
./target/release/myapp
```

## Handler Signatures

Three handler patterns are supported:

### Simple Handler
```rust
#[ui_handler]
fn on_click(model: &mut Model) {
    // Handle click
}
```
XML: `<button handler="on_click">Click</button>`

### Handler with Value
```rust
#[ui_handler]
fn on_select(model: &mut Model, item: String) {
    // Handle selection
}
```
XML: `<list handler="on_select">...</list>`

### Handler with Command
```rust
#[ui_handler]
fn on_submit(model: &mut Model) -> Command<Message> {
    // Perform async action
    Command::perform(save_data(), |result| Message::Saved(result))
}
```
XML: `<form handler="on_submit">...</form>`

## Troubleshooting

### Handler Not Found

```
Error: Handler 'on_click' referenced in window.gravity:15 not found
  --> window.gravity:15
   |
15 | <button handler="on_click">Click</button>
   |                    ^^^^^^^^
   
Did you mean: on_button_click?
```

**Solution**: Verify handler name matches exactly (case-sensitive).

### Duplicate Handler Names

```
Error: Duplicate handler name 'handle_click'
  - Defined in src/handlers.rs:42
  - Defined in src/handlers.rs:78
```

**Solution**: Rename one of the handlers to a unique name.

### Circular Dependency Detected

```
Error: Circular dependency detected
  on_submit → on_validate → on_submit
```

**Solution**: Restructure handlers to break the cycle.

### Invalid XML

```
Error: Invalid XML in window.gravity
  --> window.gravity:10
   |
10 | <button><text>Click</button></text>
   |                         ^^^^^ Expected </text>, found </button>
```

**Solution**: Fix XML syntax errors. Use `gravity check` to validate XML.

## Best Practices

1. **Use descriptive handler names**: `on_submit_form` vs `handle1`
2. **Keep handlers focused**: One responsibility per handler
3. **Prefer Simple handlers**: Less coupling, easier testing
4. **Test handlers in isolation**: Unit test handler logic separately
5. **Use --release for production**: Significant performance improvement

## Performance

### Build Time Expectations

| Project Size | Development Build | Production Build |
|--------------|-------------------|------------------|
| Small (<50 widgets) | ~5s | ~10s |
| Medium (50-200 widgets) | ~10s | ~25s |
| Large (200+ widgets) | ~20s | ~50s |

### Startup Time Improvement

Production mode typically provides 50%+ faster startup time compared to development mode due to eliminating XML parsing.

## Next Steps

- Read the [full specification](../spec.md)
- Review the [implementation plan](./plan.md)
- Explore [example projects](../../examples/)
