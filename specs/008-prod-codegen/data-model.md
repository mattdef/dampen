# Data Model: Production Mode with Static Code Generation

**Feature**: 008-prod-codegen | **Date**: 2026-01-08

## Key Entities

### HandlerInfo

Metadata structure emitted by `#[ui_handler]` macro for build-time registration.

```rust
pub struct HandlerInfo {
    /// Unique handler name referenced in XML
    pub name: &'static str,
    
    /// Handler signature classification
    pub signature_type: HandlerSignatureType,
    
    /// Parameter type names for validation
    pub param_types: &'static [&'static str],
    
    /// Return type name
    pub return_type: &'static str,
    
    /// Source file location for error messages
    pub source_file: &'static str,
    
    /// Source line number
    pub source_line: u32,
}
```

### HandlerSignatureType

Enumeration of supported handler signature patterns.

```rust
pub enum HandlerSignatureType {
    /// fn(&mut Model) -> ()
    /// Simple handler with no additional parameters
    Simple,
    
    /// fn(&mut Model, T) -> ()
    /// Handler that receives a value from the UI element
    WithValue,
    
    /// fn(&mut Model) -> Command<Message>
    /// Handler that returns a command for side effects
    WithCommand,
}
```

### GeneratedApplication

Output structure from code generation.

```rust
pub struct GeneratedApplication {
    /// Generated Rust code as string
    pub code: String,
    
    /// List of handler names discovered
    pub handlers: Vec<String>,
    
    /// List of widget types used
    pub widgets: Vec<String>,
    
    /// Any warnings generated during code gen
    pub warnings: Vec<String>,
}
```

### HandlerCallGraph

Build-time analysis structure for circular dependency detection.

```rust
pub struct HandlerCallGraph {
    /// Map of handler name to its dependencies
    dependencies: HashMap<String, Vec<String>>,
    
    /// All handlers in the application
    handlers: Vec<HandlerInfo>,
}

impl HandlerCallGraph {
    /// Detect if adding edge creates a cycle
    pub fn would_create_cycle(&self, from: &str, to: &str) -> bool;
    
    /// Get all handlers that depend on the given handler
    pub fn dependents_of(&self, handler: &str) -> Vec<String>;
}
```

## Validation Rules

1. **Handler Name Uniqueness**: No two handlers may share the same name within a scope
2. **Signature Matching**: Handler signature must match the UI element's expected signature
3. **No Circular Dependencies**: Handler call graph must be acyclic
4. **XML Reference Validity**: All handler references in XML must match defined handlers

## State Transitions

N/A - This feature deals with static code generation, not runtime state management.

## Relationships

```
HandlerInfo (produced by #[ui_handler] macro)
    ↓
HandlerRegistry (runtime mapping of names to functions)
    ↓
GravityWidgetBuilder (uses handlers when building UI)
    ↓
Application (complete generated application)
```

## File Format: ui_generated.rs

```rust
// Auto-generated by gravity build --prod
// DO NOT EDIT - regenerate with: cargo build

use gravity_core::codegen::{HandlerInfo, HandlerSignatureType};
use gravity_iced::{GravityWidgetBuilder, WidgetExt};

// Handler metadata for validation
pub static HANDLER_REGISTRY: &[HandlerInfo] = &[
    HandlerInfo {
        name: "on_click",
        signature_type: HandlerSignatureType::Simple,
        param_types: &["&mut Model"],
        return_type: "()",
        source_file: "src/handlers.rs",
        source_line: 42,
    },
    // ... more handlers
];

// Generated application code
pub fn generate_app() -> impl iced::Widget<Model, Message> {
    GravityWidgetBuilder::new()
        .container()
        .button("Click me", Some(Message::OnClick))
        .text("Hello, World!")
        .build()
}

#[derive(Clone, Debug)]
pub enum Message {
    OnClick,
}
```
