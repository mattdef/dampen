# Feature Specification: Enhanced CLI - Dampen as Primary Interface

**Feature ID**: 002-enhance-cli  
**Created**: 2026-01-10  
**Status**: Draft  
**Priority**: High

---

## üìã Overview

Make the Dampen CLI the primary interface for application developers, eliminating the need to use `cargo` directly (except for initial CLI installation via `cargo install dampen-cli`).

### Current State

Developers currently use a mix of `cargo` and `dampen` commands:
- ‚úÖ `dampen new` - Create projects
- ‚úÖ `dampen check` - Validate XML
- ‚úÖ `dampen inspect` - Inspect IR
- ‚úÖ `dampen run` - Development mode
- ‚úÖ `dampen build` - Build (has --release flag)
- ‚ùå `cargo build --release` - Production builds
- ‚ùå `cargo test` - Testing

### Desired State

Developers use only `dampen` commands:
```bash
cargo install dampen-cli    # ONLY cargo usage
dampen new my-app           # Everything else uses dampen
dampen run
dampen build
dampen release              # NEW
dampen test                 # NEW
```

---

## üéØ Objectives

### Primary Goals

1. **Complete CLI Coverage**: Provide `dampen` commands for all common development tasks
2. **Consistency**: Unified command interface for all Dampen operations
3. **Clarity**: Clear distinction between user workflow (dampen) and contributor workflow (cargo)
4. **Documentation**: Update all user-facing docs to reflect CLI-first approach

### Success Criteria

- ‚úÖ `dampen release` command implemented and functional
- ‚úÖ `dampen test` command implemented and functional
- ‚úÖ `dampen build` no longer has `--release` flag (use `dampen release` instead)
- ‚úÖ All templates generated by `dampen new` use Dampen commands
- ‚úÖ All user documentation uses Dampen commands (not cargo)
- ‚úÖ Separate USAGE.md for users vs CONTRIBUTING.md for framework contributors
- ‚úÖ All examples demonstrate Dampen CLI usage

---

## üìä Command Mapping

### User Workflow (Application Development)

| Old Command | New Command | Notes |
|-------------|-------------|-------|
| `cargo new <name>` | `dampen new <name>` | ‚úÖ Already exists |
| `cargo run` | `dampen run` | ‚úÖ Already exists |
| `cargo build` | `dampen build` | ‚úÖ Exists, needs adjustment |
| `cargo build --release` | `dampen release` | ‚ùå To be created |
| `cargo test` | `dampen test` | ‚ùå To be created |
| `cargo check` | `dampen check` | ‚úÖ Already exists (validates XML) |

### Contributor Workflow (Framework Development)

Framework contributors continue using `cargo` directly:
```bash
cargo build --workspace
cargo test --workspace
cargo clippy --workspace -- -D warnings
```

---

## üó∫Ô∏è Implementation Plan

### Phase 1: Create `dampen release` Command

**Duration**: 30 minutes

#### Files to Create
- `crates/dampen-cli/src/commands/release.rs` (~150 lines)

#### Files to Modify
- `crates/dampen-cli/src/lib.rs` - Add Release variant
- `crates/dampen-cli/src/commands/mod.rs` - Export release module

#### Implementation Details

**Command Signature**:
```rust
#[derive(clap::Args)]
pub struct ReleaseArgs {
    /// Package to build (workspace support)
    #[arg(short, long)]
    package: Option<String>,

    /// Additional features beyond codegen
    #[arg(long, value_delimiter = ',')]
    features: Vec<String>,

    /// Verbose output
    #[arg(short, long)]
    verbose: bool,

    /// Custom target directory
    #[arg(long)]
    target_dir: Option<String>,
}
```

**Behavior**:
```bash
dampen release
# Executes: cargo build --release --features codegen

dampen release -p my-app
# Executes: cargo build --release -p my-app --features codegen

dampen release --features tokio
# Executes: cargo build --release --features codegen,tokio
```

**Validation**:
- Checks `Cargo.toml` exists
- Checks `build.rs` exists
- Always adds `--release` flag
- Always includes `codegen` feature
- Supports workspace packages via `-p`

---

### Phase 2: Create `dampen test` Command

**Duration**: 25 minutes

#### Files to Create
- `crates/dampen-cli/src/commands/test.rs` (~120 lines)

#### Files to Modify
- `crates/dampen-cli/src/lib.rs` - Add Test variant
- `crates/dampen-cli/src/commands/mod.rs` - Export test module

#### Implementation Details

**Command Signature**:
```rust
#[derive(clap::Args)]
pub struct TestArgs {
    /// Package to test
    #[arg(short, long)]
    package: Option<String>,

    /// Test name filter
    #[arg(value_name = "TESTNAME")]
    test_filter: Option<String>,

    /// Arguments for test binary
    #[arg(last = true)]
    test_args: Vec<String>,

    /// Run in release mode
    #[arg(long)]
    release: bool,

    /// Run ignored tests
    #[arg(long)]
    ignored: bool,

    /// Quiet output
    #[arg(long)]
    quiet: bool,

    /// Verbose output
    #[arg(short, long)]
    verbose: bool,

    /// Additional features
    #[arg(long, value_delimiter = ',')]
    features: Vec<String>,
}
```

**Behavior**:
```bash
dampen test
# Executes: cargo test

dampen test my_test
# Executes: cargo test my_test

dampen test -- --nocapture
# Executes: cargo test -- --nocapture

dampen test -p my-app --release
# Executes: cargo test -p my-app --release
```

**Features**:
- Transparent wrapper around `cargo test`
- Supports all common test flags
- Workspace support via `-p`
- Pass-through arguments to test binary

---

### Phase 3: Adjust `dampen build` Command

**Duration**: 15 minutes

#### Files to Modify
- `crates/dampen-cli/src/commands/build.rs`

#### Changes Required

**Remove `--release` flag**:
- Delete `release: bool` field from `BuildArgs`
- Remove conditional release logic
- Update documentation to clarify debug-only builds

**Updated Behavior**:
```bash
dampen build
# Executes: cargo build --features codegen
# Output: target/debug/

dampen release
# Executes: cargo build --release --features codegen
# Output: target/release/
```

**Documentation Updates**:
```rust
/// Execute the build command
///
/// Builds the application in debug mode with codegen.
///
/// # Mode Behavior
///
/// - **Debug Mode with Codegen**: Compile-time code generation without optimizations
/// - Faster compilation than release mode
/// - Useful for debugging production codegen behavior
/// - Use `dampen release` for optimized production builds
```

---

### Phase 4: Update Project Templates

**Duration**: 20 minutes

#### Files to Modify
- `crates/dampen-cli/templates/new/README.md.template`

#### Changes Required

**Quick Start Section**:
```markdown
## Quick Start

Run the application in development mode (with hot-reload):

```bash
dampen run
```

Build for production:

```bash
dampen release
```
```

**Add CLI Commands Section**:
```markdown
## CLI Commands

Dampen provides a comprehensive CLI for all development tasks:

```bash
# Development
dampen run              # Run in dev mode with hot-reload
dampen run -- --arg     # Pass arguments to your application

# Building
dampen build            # Debug build with codegen
dampen release          # Production build (optimized)

# Validation & Inspection
dampen check            # Validate .dampen XML files
dampen inspect <file>   # Inspect IR and generated code

# Testing
dampen test             # Run all tests
dampen test <name>      # Run specific test
```

**Note**: You only need `cargo` to install the Dampen CLI initially:
```bash
cargo install dampen-cli
```
```

**Update All Commands**:
- Replace `cargo run` ‚Üí `dampen run`
- Replace `cargo build --release` ‚Üí `dampen release`
- Replace `cargo test` ‚Üí `dampen test`

---

### Phase 5: Create USAGE.md (User Documentation)

**Duration**: 30 minutes

#### Files to Create
- `docs/USAGE.md` (~400 lines)

#### Structure

```markdown
# Dampen Usage Guide

**For Application Developers**

## Table of Contents
1. Installation
2. Creating a New Project
3. Development Workflow
4. CLI Commands Reference
5. Common Tasks
6. Troubleshooting

## Installation

```bash
cargo install dampen-cli
```

**Note**: This is the ONLY time you need cargo.

## CLI Commands Reference

### dampen new <name>
Create a new Dampen project.

### dampen run
Run in development mode with hot-reload.

### dampen build
Build debug version with codegen.

### dampen release
Build optimized production binary.

### dampen test
Run test suite.

### dampen check
Validate .dampen XML files.

### dampen inspect
Inspect IR and generated code.

## Common Tasks
- Adding a new view
- Adding event handlers
- Debugging build issues
- Working with workspaces

## Troubleshooting
- CLI not found
- Hot-reload not working
- Build fails
- Tests fail
```

---

### Phase 6: Update Main Documentation

**Duration**: 45 minutes

#### Files to Modify

**1. README.md** (root)
- Add note about CLI after installation section
- Verify all commands use `dampen`

**2. docs/QUICKSTART.md**
- Update Installation section
- Replace all `cargo run` ‚Üí `dampen run`
- Replace all `cargo build` ‚Üí `dampen build` or `dampen release`
- Update CLI Commands section

**3. docs/development/dual-mode.md**
- Add note distinguishing user vs contributor workflow
- Update all example commands to use `dampen`
- Keep cargo commands in contributor sections

**4. docs/migration/dual-mode.md**
- Update migration workflow
- Show old workflow (cargo) vs new workflow (dampen)
- Update all code examples

**5. docs/performance.md**
- Update benchmark commands
- Note when cargo is appropriate (detailed analysis)

**6. docs/AUTOMATION.md**
- Verify and update if needed

**7. docs/STYLING.md** & **docs/XML_SCHEMA.md**
- Verify no outdated cargo commands

#### Guiding Principles

- **User docs** ‚Üí Use `dampen` commands exclusively
- **Contributor docs** ‚Üí Can reference `cargo` for framework development
- **Always note** ‚Üí `cargo install dampen-cli` is the only cargo usage for users

---

### Phase 7: Update Examples Documentation

**Duration**: 30 minutes

#### Files to Modify

**1. examples/README.md**
- Replace all `cargo run -p <name>` ‚Üí `dampen run -p <name>`
- Update "Running Examples" section
- Update "Getting Started" section
- Replace `cargo build --examples` ‚Üí `dampen build`

**2. examples/todo-app/README.md**
- Update Quick Start
- Replace cargo commands

**3. examples/styling/README.md**
- Update running instructions
- Replace cargo commands

**4. examples/widget-showcase/README.md**
- Update running instructions
- Replace cargo commands

**5. Other example READMEs** (if they exist)
- Verify and update consistently

#### Pattern

```markdown
# BEFORE
```bash
cargo run -p hello-world
```

# AFTER
```bash
dampen run -p hello-world
```
```

---

### Phase 8: Update AGENTS.md

**Duration**: 20 minutes

#### File to Modify
- `AGENTS.md`

#### Changes Required

**Add Workflow Distinction**:
```markdown
## Two Workflows

### Application Development (Using Dampen)

When building applications WITH Dampen:
- Use `dampen` CLI commands exclusively
- `cargo` only needed for initial CLI installation
- See [USAGE.md](docs/USAGE.md) for complete guide

### Framework Development (Contributing to Dampen)

When working ON the Dampen framework:
- Use `cargo` workspace commands
- Direct access to all crates
- See [CONTRIBUTING.md](docs/CONTRIBUTING.md) for workflow
```

**Update Commands Section**:
```markdown
## Commands

### For Application Developers

```bash
dampen new my-app
dampen run
dampen build
dampen release
dampen test
dampen check
dampen inspect <file>
```

### For Framework Contributors

```bash
cargo build --workspace
cargo test --workspace
cargo clippy --workspace
cargo doc --workspace
```
```

**Update Project Creation Section**:
```markdown
### Creating a New Project

```bash
dampen new my-app
cd my-app
dampen run
```
```

---

### Phase 9: Testing & Validation

**Duration**: 30 minutes

#### Test Scenarios

**T9.1: Test `dampen release`**
```bash
cd /tmp
dampen new test-release
cd test-release
dampen release
./target/release/test-release
```

Validation:
- ‚úÖ Binary created in `target/release/`
- ‚úÖ Build uses `--features codegen`
- ‚úÖ Optimizations enabled
- ‚úÖ Success messages clear

**T9.2: Test `dampen test`**
```bash
dampen test
dampen test --verbose
dampen test -- --nocapture
```

Validation:
- ‚úÖ Tests execute
- ‚úÖ Options passed correctly
- ‚úÖ Error messages clear

**T9.3: Test `dampen build`** (modified)
```bash
dampen build
ls -lh target/debug/
```

Validation:
- ‚úÖ Binary in `target/debug/`
- ‚úÖ No optimizations
- ‚úÖ Codegen enabled

**T9.4: Test Templates**
```bash
dampen new test-template
cd test-template
cat README.md | grep "dampen run"
dampen check
dampen run &
sleep 5
pkill test-template
dampen build
dampen release
```

Validation:
- ‚úÖ README uses Dampen commands
- ‚úÖ Full workflow works
- ‚úÖ No outdated cargo references

**T9.5: Verify Documentation**
```bash
grep -r "cargo run" docs/ | grep -v "CONTRIBUTING.md" | grep -v "RELEASE.md"
grep -r "cargo build" docs/ | grep -v "CONTRIBUTING.md" | grep -v "RELEASE.md"
ls -lh docs/USAGE.md
```

Validation:
- ‚úÖ Minimal cargo mentions in user docs
- ‚úÖ USAGE.md exists and complete
- ‚úÖ All commands documented

**T9.6: Test Examples**
```bash
cd examples/counter
dampen run &
sleep 5
pkill counter
```

Validation:
- ‚úÖ Examples work with `dampen run`
- ‚úÖ No errors

**T9.7: Verify Workspace Support**
```bash
dampen run -p counter
dampen build -p hello-world
dampen release -p todo-app
```

Validation:
- ‚úÖ `-p` flag works
- ‚úÖ Individual packages compile

---

## üì¶ Deliverables

### New Files (3)
1. ‚úÖ `crates/dampen-cli/src/commands/release.rs` (~150 lines)
2. ‚úÖ `crates/dampen-cli/src/commands/test.rs` (~120 lines)
3. ‚úÖ `docs/USAGE.md` (~400 lines)

### Modified Files (19+)

#### CLI Implementation (3)
1. ‚úÖ `crates/dampen-cli/src/lib.rs`
2. ‚úÖ `crates/dampen-cli/src/commands/mod.rs`
3. ‚úÖ `crates/dampen-cli/src/commands/build.rs`

#### Templates (1)
4. ‚úÖ `crates/dampen-cli/templates/new/README.md.template`

#### Main Documentation (7)
5. ‚úÖ `README.md`
6. ‚úÖ `docs/QUICKSTART.md`
7. ‚úÖ `docs/development/dual-mode.md`
8. ‚úÖ `docs/migration/dual-mode.md`
9. ‚úÖ `docs/performance.md`
10. ‚úÖ `docs/AUTOMATION.md` (if needed)
11. ‚úÖ `docs/STYLING.md` (verify)

#### Examples (5+)
12. ‚úÖ `examples/README.md`
13. ‚úÖ `examples/todo-app/README.md`
14. ‚úÖ `examples/styling/README.md`
15. ‚úÖ `examples/widget-showcase/README.md`
16. ‚úÖ Other example READMEs

#### Configuration (1)
17. ‚úÖ `AGENTS.md`

---

## üéØ Success Criteria

### Functional Requirements

- ‚úÖ **FR-001**: `dampen release` command builds optimized production binaries
- ‚úÖ **FR-002**: `dampen test` command runs test suite with full feature parity to cargo test
- ‚úÖ **FR-003**: `dampen build` only builds debug (no --release flag)
- ‚úÖ **FR-004**: All commands support workspace operations via `-p/--package`
- ‚úÖ **FR-005**: Templates generate projects using Dampen CLI exclusively
- ‚úÖ **FR-006**: User documentation references Dampen CLI, not cargo (except installation)
- ‚úÖ **FR-007**: Clear distinction between user workflow (USAGE.md) and contributor workflow (CONTRIBUTING.md)

### Quality Requirements

- ‚úÖ **QR-001**: All new commands have comprehensive help text
- ‚úÖ **QR-002**: All commands follow consistent argument naming
- ‚úÖ **QR-003**: Error messages are clear and actionable
- ‚úÖ **QR-004**: Documentation is consistent across all files
- ‚úÖ **QR-005**: Examples demonstrate CLI best practices
- ‚úÖ **QR-006**: No breaking changes to existing functionality

### Testing Requirements

- ‚úÖ **TR-001**: `dampen release` tested with basic build, workspace, and features
- ‚úÖ **TR-002**: `dampen test` tested with filters, arguments, and packages
- ‚úÖ **TR-003**: `dampen build` verified to only build debug
- ‚úÖ **TR-004**: Templates validated to use correct commands
- ‚úÖ **TR-005**: Documentation verified to be consistent
- ‚úÖ **TR-006**: Examples tested and functional
- ‚úÖ **TR-007**: Workspace support validated across all commands

---

## üìä Implementation Summary

### Estimated Effort

| Phase | Duration | Complexity |
|-------|----------|------------|
| Phase 1: `dampen release` | 30 min | Medium |
| Phase 2: `dampen test` | 25 min | Medium |
| Phase 3: Adjust `dampen build` | 15 min | Low |
| Phase 4: Update templates | 20 min | Low |
| Phase 5: Create USAGE.md | 30 min | Medium |
| Phase 6: Update main docs | 45 min | Medium |
| Phase 7: Update examples | 30 min | Low |
| Phase 8: Update AGENTS.md | 20 min | Low |
| Phase 9: Testing | 30 min | Medium |
| **Total** | **~3h 45min** | **Medium** |

### Dependencies

- Phase 2 can start immediately after Phase 1
- Phase 3 can run in parallel with Phases 1-2
- Phase 4 depends on Phases 1-3 (needs final command structure)
- Phases 5-8 can run in parallel (documentation updates)
- Phase 9 depends on all previous phases

### Risks & Mitigation

| Risk | Impact | Mitigation |
|------|--------|------------|
| Breaking existing workflows | High | Maintain backward compatibility where possible |
| Documentation inconsistency | Medium | Systematic search/replace + validation |
| Missing edge cases in commands | Medium | Comprehensive testing suite (Phase 9) |
| User confusion about cargo vs dampen | Medium | Clear USAGE.md and prominent notes |

---

## üöÄ Next Steps

1. **Review & Approval**: Get feedback on this specification
2. **Implementation**: Execute phases 1-9 in order
3. **Validation**: Run full test suite (Phase 9)
4. **Documentation**: Ensure all docs are updated
5. **Release**: Tag as feature completion

---

## üìù Notes

### Design Decisions

**Q1: Why create `dampen test` instead of using `cargo test`?**
- **A**: Consistency - users should use one tool (dampen) for everything
- Allows future enhancements (e.g., XML-aware test filtering)
- Matches pattern of other commands

**Q2: Why separate USAGE.md from CONTRIBUTING.md?**
- **A**: Different audiences with different needs
- Users don't need cargo workspace commands
- Contributors need more detailed framework information
- Reduces confusion

**Q3: Why remove `--release` from `dampen build`?**
- **A**: Clarity - one command per build type
- Matches cargo convention (`cargo build` vs `cargo build --release`)
- Users explicitly choose debug vs release

**Q4: Why not add more commands (watch, clean, doc)?**
- **A**: Start simple, add later based on user feedback
- Focus on most common workflows first
- Can iterate based on usage patterns

### Future Enhancements (Out of Scope)

- `dampen watch` - Auto-rebuild on file changes
- `dampen dev` - Alias for run with auto-reload
- `dampen clean` - Clean build artifacts
- `dampen doc` - Generate documentation
- `dampen format` - Format .dampen XML files
- `dampen upgrade` - Upgrade Dampen dependencies
- `dampen publish` - Publish to package registry

---

## üìö References

- Dual-mode architecture spec: `specs/001-dual-mode-architecture/`
- Current CLI implementation: `crates/dampen-cli/`
- Templates: `crates/dampen-cli/templates/`
- Documentation: `docs/`
- Examples: `examples/`

---

**Status**: Ready for implementation  
**Next Action**: Begin Phase 1 (Create `dampen release` command)
