# Implementation Plan: Dual-Mode Architecture

**Branch**: `001-dual-mode-architecture` | **Date**: 2026-01-09 | **Spec**: [spec.md](./spec.md)  
**Input**: Feature specification from `/specs/001-dual-mode-architecture/spec.md`

## Summary

Implement two distinct execution modes for Dampen applications: **Interpreted Mode** for development with hot-reload capabilities, and **Codegen Mode** for production with zero runtime overhead. This aligns with Constitution Principle III (Dual-Mode Architecture) and enables rapid development iteration while maintaining production performance comparable to hand-written code.

**Technical Approach**: Extend the existing hybrid architecture (compile-time XML loading + runtime binding evaluation) into two fully distinct modes. Development mode adds file watching and hot-reload infrastructure via a new `dampen-dev` crate. Production mode completes the code generation pipeline to inline all bindings and eliminate runtime interpretation entirely.

## Technical Context

**Language/Version**: Rust Edition 2024, MSRV stable (no nightly features in public API)  
**Primary Dependencies**: 
- `iced` 0.14+ (UI backend)
- `roxmltree` 0.19+ (XML parsing)
- `notify` 6.0+ (file watching for hot-reload)
- `serde`/`serde_json` 1.0+ (serialization)
- `syn` 2.0+, `quote` 2.0+, `proc-macro2` 2.0+ (code generation)

**Storage**: File-based (`.dampen` XML UI definitions, optional `.dampen-state.json` for state persistence)  
**Testing**: `cargo test` with `proptest` 1.0+ (property-based), `insta` 1.0+ (snapshot testing)  
**Target Platform**: Cross-platform desktop (Windows, Linux, macOS) via Iced  
**Project Type**: Single workspace with multiple library crates  
**Performance Goals**: 
- Hot-reload latency < 300ms
- File change detection < 100ms
- Production frame rendering within 5% of hand-written equivalent
- XML parse time < 10ms for 1000-widget file

**Constraints**: 
- Zero runtime XML parsing overhead in production mode
- No application state loss during hot-reload
- Generated code must be clippy-clean
- All widgets must work identically in both modes

**Scale/Scope**: 
- Support for 1000+ widgets per UI file
- 10+ concurrent file watches in development mode
- All existing 20+ widget types
- 3 core expression types (field access, binary ops, method calls)

## Constitution Check

*GATE: Must pass before Phase 0 research. Re-check after Phase 1 design.*

### ✅ I. Declarative-First
- **Status**: PASS
- **Rationale**: Feature enhances the declarative architecture without changing XML as the source of truth. Both modes operate on the same XML definitions.

### ✅ II. Type Safety Preservation
- **Status**: PASS
- **Rationale**: Codegen mode strengthens type safety by moving binding validation to compile-time. Development mode maintains runtime type checking through existing `UiBindable` trait.

### ✅ III. Dual-Mode Architecture (PRIMARY CONSTITUTIONAL REQUIREMENT)
- **Status**: PASS - This feature IS the constitutional requirement
- **Rationale**: Directly implements Constitution Principle III. Provides both development and production modes with identical semantic behavior.

### ✅ IV. Backend Abstraction
- **Status**: PASS
- **Rationale**: Feature operates at the framework level, preserving backend abstraction. Hot-reload and codegen work with the existing `Backend` trait.

### ✅ V. Test-First Development
- **Status**: PASS
- **Rationale**: Plan includes comprehensive test strategy with contract tests, integration tests, and property-based tests for both modes.

**GATE RESULT**: ✅ **PASSED** - All constitutional principles satisfied. Proceed to Phase 0.

## Project Structure

### Documentation (this feature)

```text
specs/001-dual-mode-architecture/
├── plan.md              # This file
├── research.md          # Phase 0 output (technology decisions)
├── data-model.md        # Phase 1 output (state and configuration models)
├── quickstart.md        # Phase 1 output (developer guide)
├── contracts/           # Phase 1 output (API contracts)
│   ├── file-watcher-api.md
│   ├── codegen-api.md
│   └── error-overlay-api.md
├── checklists/
│   └── requirements.md  # Spec validation checklist
└── tasks.md             # Phase 2 output (generated by /speckit.tasks)
```

### Source Code (repository root)

```text
crates/
├── dampen-core/              # Existing - Parser, AST, IR, trait definitions
│   ├── src/
│   │   ├── lib.rs
│   │   ├── parser/           # XML parsing (existing)
│   │   ├── ir/               # Intermediate representation (existing)
│   │   ├── expr/             # Expression AST and evaluation (existing)
│   │   ├── binding/          # UiBindable trait (existing)
│   │   ├── handler/          # Handler registry (existing)
│   │   ├── codegen/          # Code generation (EXTEND for full codegen)
│   │   │   ├── mod.rs
│   │   │   ├── view.rs       # Widget code generation (EXTEND)
│   │   │   ├── bindings.rs   # Binding expression inlining (NEW)
│   │   │   └── handlers.rs   # Handler dispatch generation (NEW)
│   │   ├── state/            # AppState (EXTEND for hot-reload)
│   │   │   └── mod.rs        # Add hot_reload() method
│   │   └── traits/           # Backend abstraction (existing)
│   └── tests/
│       └── codegen_tests.rs  # NEW - Codegen contract tests
│
├── dampen-macros/            # Existing - Proc macros
│   ├── src/
│   │   ├── lib.rs
│   │   ├── ui_model.rs       # #[derive(UiModel)] (existing)
│   │   └── ui_loader.rs      # #[dampen_ui] (EXTEND for mode selection)
│   └── tests/
│       └── codegen_mode_tests.rs  # NEW - Test codegen mode compilation
│
├── dampen-runtime/           # Existing - Interpreter
│   ├── src/
│   │   ├── lib.rs
│   │   ├── interpreter.rs    # Runtime binding evaluation (existing)
│   │   ├── state.rs          # State management (existing)
│   │   └── overlay.rs        # Error overlay (existing)
│   └── tests/
│
├── dampen-dev/               # NEW - Development mode tooling
│   ├── Cargo.toml
│   ├── src/
│   │   ├── lib.rs
│   │   ├── watcher.rs        # File watching with notify crate
│   │   ├── reload.rs         # Hot-reload coordination
│   │   ├── overlay.rs        # Error overlay UI components
│   │   └── subscription.rs   # Iced subscription for file events
│   └── tests/
│       ├── watcher_tests.rs
│       └── reload_tests.rs
│
├── dampen-iced/              # Existing - Iced backend
│   ├── src/
│   │   ├── lib.rs
│   │   ├── builder.rs        # DampenWidgetBuilder (existing, keep for dev mode)
│   │   ├── widgets/          # IR-to-Iced mapping (existing)
│   │   ├── theme.rs          # Theme support (existing)
│   │   └── commands.rs       # Command handling (existing)
│   └── tests/
│
└── dampen-cli/               # Existing - Developer CLI
    ├── src/
    │   ├── main.rs
    │   ├── commands/
    │   │   ├── mod.rs
    │   │   ├── new.rs        # Project scaffolding (EXTEND for dual-mode template)
    │   │   ├── check.rs      # XML validation (existing)
    │   │   ├── run.rs        # NEW - Development mode launcher
    │   │   ├── build.rs      # NEW - Production build wrapper
    │   │   └── inspect.rs    # IR inspection (existing)
    │   └── config.rs
    └── tests/

examples/
├── counter/                  # EXTEND - Update to support both modes
│   ├── build.rs              # NEW - Production codegen
│   ├── Cargo.toml            # EXTEND - Add feature flags
│   └── src/
│       └── main.rs           # EXTEND - Conditional compilation
├── todo-app/                 # EXTEND - Update to support both modes
│   ├── build.rs              # NEW
│   ├── Cargo.toml            # EXTEND
│   └── src/
│       └── main.rs           # EXTEND
└── hello-world/              # EXTEND - Update to support both modes
    ├── build.rs              # NEW
    ├── Cargo.toml            # EXTEND
    └── src/
        └── main.rs           # EXTEND

tests/
├── integration/              # NEW - Dual-mode integration tests
│   ├── hot_reload_tests.rs
│   ├── codegen_tests.rs
│   └── mode_parity_tests.rs  # Ensure both modes produce same behavior
└── benchmarks/               # NEW - Performance benchmarks
    ├── dev_mode_bench.rs
    └── prod_mode_bench.rs
```

**Structure Decision**: Single workspace with multiple library crates (existing architecture). New `dampen-dev` crate added for development-mode-specific functionality (file watching, hot-reload). Existing crates extended with new modules for codegen completion and mode selection. This preserves the clean separation mandated by Constitution Principle IV (Backend Abstraction).

## Complexity Tracking

> **Fill ONLY if Constitution Check has violations that must be justified**

**Status**: No violations detected. All constitutional principles are satisfied by this feature design.

