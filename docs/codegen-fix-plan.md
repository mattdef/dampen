# Plan de correction du mode Codegen

## Contexte

Le mode codegen (`dampen build`/`dampen release`) génère du code Rust statique à partir des fichiers `.dampen`. Actuellement, ce mode a plusieurs bugs qui empêchent la compilation du code généré.

Le mode **interpreted** (`dampen run` et `dampen release --interpreted`) fonctionne correctement et est recommandé en attendant ces corrections.

## Bugs identifiés

### 1. Double `match message` dans `update_model()`

**Fichier:** `crates/dampen-core/src/codegen/mod.rs` (ligne ~340)

**Problème:** Le code génère:
```rust
pub fn update_model(model: &mut Model, message: Message) -> Task<Message> {
    match message {
        match message {  // <- Double match!
            Message::Greet => { ... }
        }
        Message::SystemThemeChanged(theme_name) => { ... }
    }
}
```

**Cause:** `generate_application_with_theme_and_subscriptions()` imbrique `update_match_arms` dans un `match message {}`, mais `update_match_arms` génère déjà son propre `match`.

**Solution:**
```rust
// Dans generate_application_with_theme_and_subscriptions()
// Changer:
pub fn update_model(...) -> Task<Message> {
    match message {
        #update_match_arms
        #system_theme_arm
    }
}

// En:
pub fn update_model(...) -> Task<Message> {
    #update_match_arms  // Contient déjà le match
}
```

Et modifier `update.rs` pour accepter des arms supplémentaires.

---

### 2. Inner attributes `#![doc]` au lieu de `#[doc]`

**Fichier:** `crates/dampen-core/src/codegen/theme.rs`

**Problème:** Le code du thème utilise `//!` qui devient `#![doc = "..."]` (inner attribute), invalide quand inclus via `include!()`.

**Solution:** Changer les commentaires de documentation:
```rust
// Avant (ligne ~63-64):
code.push_str("//! Generated theme code - DO NOT EDIT\n");
code.push_str("//! This file is auto-generated by the dampen codegen.\n\n");

// Après:
code.push_str("// Generated theme code - DO NOT EDIT\n");
code.push_str("// This file is auto-generated by the dampen codegen.\n\n");
```

---

### 3. Champ `model.count` hardcodé

**Fichier:** `crates/dampen-core/src/codegen/mod.rs` (ligne ~350)

**Problème:**
```rust
pub fn view_model(model: &Model) -> Element<'_, Message> {
    let count = &model.count;  // <- Hardcodé!
    ...
}
```

**Solution:** Supprimer cette ligne hardcodée ou la rendre dynamique basée sur les champs du modèle.

---

### 4. Widgets mal générés dans `view.rs`

**Fichier:** `crates/dampen-core/src/codegen/view.rs`

**Problèmes multiples:**

#### 4.1 Pas de `.into()` sur le widget racine
```rust
// Généré:
iced::widget::column(vec![...]).spacing(20f32).padding(20f32)

// Devrait être:
iced::widget::column(vec![...]).spacing(20f32).padding(20f32).into()
```

#### 4.2 `container()` prend un seul enfant, pas un Vec
```rust
// Généré:
iced::widget::container(vec![...])

// Devrait être:
iced::widget::container(iced::widget::column(vec![...]))
```

#### 4.3 `Rule::default()` et `Space::default()` n'existent pas
```rust
// Généré:
iced::widget::Rule::default()
iced::widget::Space::default()

// Devrait être:
iced::widget::horizontal_rule(1)
iced::widget::Space::new(iced::Length::Fill, iced::Length::Shrink)
```

#### 4.4 `button()` attend un `impl Into<Element>`, pas `String`
```rust
// Généré:
iced::widget::button("Click me!".to_string())

// Devrait être:
iced::widget::button(iced::widget::text("Click me!"))
```

#### 4.5 `Message::greet(None)` au lieu de `Message::Greet`
```rust
// Généré:
.on_press(Message::greet(None))

// Devrait être:
.on_press(Message::Greet)
```

---

### 5. Variable `message` non définie dans la vue

**Fichier:** `crates/dampen-core/src/codegen/view.rs`

**Problème:** Le binding `{message}` génère `message.to_string()` mais `message` n'est pas défini.

**Solution:** Les bindings doivent accéder au modèle:
```rust
// Généré:
iced::widget::text(message.to_string())

// Devrait être:
iced::widget::text(model.message.to_string())
```

---

### 6. Import `crate::ui::window` incorrect

**Fichier:** `crates/dampen-core/src/codegen/mod.rs`

**Problème:**
```rust
use crate::ui::window::{self, Model};
```

Ce chemin suppose une structure de projet spécifique.

**Solution:** Rendre le chemin configurable ou le supprimer.

---

## Plan d'implémentation

### Phase 1: Corrections critiques (compilation)

1. **Fixer le double match** dans `mod.rs`
   - Modifier `generate_application_with_theme_and_subscriptions()` pour ne pas wrapper dans un match
   - Modifier `update.rs` pour accepter des arms supplémentaires en paramètre

2. **Fixer les inner attributes** dans `theme.rs`
   - Changer `//!` en `//` pour les commentaires de documentation

3. **Supprimer `let count = &model.count`** dans `mod.rs`

### Phase 2: Corrections des widgets (view.rs)

4. **Ajouter `.into()` au widget racine**
   - Modifier `generate_view()` pour ajouter `.into()` à la fin

5. **Corriger `container()`**
   - `generate_container()` doit wrapper les enfants dans une `column` si plusieurs

6. **Corriger `Rule` et `Space`**
   - `generate_rule()` → `horizontal_rule(height)` ou `vertical_rule(width)`
   - `generate_space()` → `Space::new(width, height)`

7. **Corriger `button()`**
   - Le label doit être `text(label)` et non une `String` directe

8. **Corriger le message variant**
   - `Message::handler_name` → `Message::HandlerName` (sans parenthèses si pas de param)

### Phase 3: Corrections des bindings (bindings.rs / view.rs)

9. **Préfixer les bindings avec `model.`**
   - `{field}` → `model.field`
   - `{method()}` → `model.method()`

10. **Rendre les imports configurables**
    - Supprimer ou rendre optionnel `use crate::ui::window`

### Phase 4: Tests

11. **Ajouter des tests de snapshot** pour le code généré
12. **Tester avec l'exemple hello-world**
13. **Tester avec des UI plus complexes**

---

## Fichiers à modifier

| Fichier | Changements |
|---------|-------------|
| `crates/dampen-core/src/codegen/mod.rs` | Fix double match, remove hardcoded count, fix imports |
| `crates/dampen-core/src/codegen/theme.rs` | Fix inner attributes |
| `crates/dampen-core/src/codegen/view.rs` | Fix widgets, add .into(), fix bindings |
| `crates/dampen-core/src/codegen/update.rs` | Accept additional match arms |
| `crates/dampen-core/src/codegen/handlers.rs` | Fix message variant naming |

---

## Estimation

- **Phase 1:** ~1-2 heures (corrections critiques)
- **Phase 2:** ~2-3 heures (corrections widgets)
- **Phase 3:** ~1-2 heures (corrections bindings)
- **Phase 4:** ~1 heure (tests)

**Total estimé:** 5-8 heures de travail

---

## Alternative recommandée

En attendant ces corrections, utiliser:
```bash
dampen release --interpreted
```

Cette commande utilise le mode macro (`#[dampen_app]`) en build release, qui fonctionne correctement avec le support du thème système.
